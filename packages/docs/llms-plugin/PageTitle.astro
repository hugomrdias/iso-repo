---
import Default from "@astrojs/starlight/components/PageTitle.astro";
import { Icon } from "@astrojs/starlight/components";
import config from "virtual:starlight-page-actions/config";

interface OptionsProps {
  label: string;
  href: string;
  id: "chatgpt" | "claude" | "markdown" | "v0" | "t3chat";
}

const currentPath = Astro.url.pathname.replace(/\/$/, "");
const currentUrl = Astro.url.href;
const { actions, prompt: userPrompt } = config;
const { pageActions } = (Astro.locals as any).starlightRoute.entry.data;

const prompt = userPrompt?.includes("{url}")
  ? userPrompt?.replace("{url}", currentUrl)
  : `${userPrompt} ${currentUrl}`;
const encodedPrompt = encodeURIComponent(prompt as string);

const defaultOptions: OptionsProps[] = [
  {
    label: "Open in ChatGPT",
    href: `https://chatgpt.com/?q=${encodedPrompt}`,
    id: "chatgpt",
  },
  {
    label: "Open in Claude",
    href: `https://claude.ai/new?q=${encodedPrompt}`,
    id: "claude",
  },
  {
    label: "Open in T3 Chat",
    href: `https://t3.chat/new?q=${encodedPrompt}`,
    id: "t3chat",
  },
  {
    label: "Open in v0",
    href: `https://v0.app/?q=${encodedPrompt}`,
    id: "v0",
  },
  {
    label: "View in Markdown",
    href: `${currentPath}.md`,
    id: "markdown",
  },
];
const filteredDefaultOptions = defaultOptions.filter((option) => {
  const id = option.id;

  if (actions && actions[id]) {
    return option;
  }

  return;
});
const customOptions: OptionsProps[] = actions?.custom
  ? Object.entries(actions.custom).map(([key, value]) => {
      return {
        label: value.label,
        href: `${value.href}${encodedPrompt}`,
        id: key as OptionsProps["id"],
      };
    })
  : [];
const options = [...filteredDefaultOptions, ...customOptions];
---

{
  pageActions || typeof pageActions === "undefined" ? (
    <Default />
    <div class="actions-container">
      <button class="action-button" id="copy-markdown" data-path={currentPath}>
        <Icon name="mdx" size="1rem" class="icon-default" />
        <Icon name="approve-check" size="1rem" class="icon-success" />
        <Icon name="error" size="1rem" class="icon-error" />
        <span>Copy Markdown</span>
      </button>

      {
        options.length !== 0 && (
          <div class="dropdown">
            <button
              class="action-button"
              id="dropdown-toggle"
              aria-label="More options"
            >
              <span>Open</span>
              <Icon name="down-caret" size="1rem" />
            </button>

            <div id="dropdown-menu">
              {options.map((option) => {
                return (
                  <a href={option.href} class="dropdown-item" target="_blank">
                    <span>{option.label}</span>
                    <Icon name="external" size="1rem" class="external-icon" />
                  </a>
                );
              })}
            </div>
          </div>
        )
      }
    </div>
  ) : (
    <Default />
  )
}

<style>
  .actions-container {
    display: flex;
    gap: 0.5rem;
  }

  .action-button {
    background-color: var(--sl-color-gray-6);
    color: var(--sl-color-white);
    border: 1px solid var(--sl-color-gray-5);
    padding: 0.5rem 0.75rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    font-family: var(--sl-font);
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: opacity 0.2s ease;
    height: 2rem;
    line-height: 1;
  }

  #copy-markdown:disabled {
    opacity: 0.7;
  }

  .icon-success,
  .icon-error {
    display: none;
  }

  #copy-markdown.copied .icon-default,
  #copy-markdown.error .icon-default {
    display: none;
  }

  #copy-markdown.copied .icon-success,
  #copy-markdown.error .icon-error {
    display: block;
  }

  .dropdown {
    position: relative;
  }

  #dropdown-menu {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    background-color: var(--sl-color-gray-6);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.25rem;
    padding: 0.25rem;
    min-width: 200px;
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.3),
      0 2px 4px -1px rgba(0, 0, 0, 0.2);
    display: none;
    z-index: 10;
  }

  #dropdown-menu.show {
    display: block;
  }

  .dropdown-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    color: var(--sl-color-white);
    text-decoration: none;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    transition: background-color 0.15s ease;
    cursor: pointer;
  }

  .dropdown-item:hover {
    background-color: var(--sl-color-gray-5);
  }

  .dropdown-item span {
    flex: 1;
  }

  .dropdown-item .external-icon {
    margin-left: auto;
  }
</style>

<script>
  const copyButton = document.querySelector(
    "#copy-markdown"
  ) as HTMLButtonElement;
  let copyButttonClass: "copied" | "error" = "copied";

  copyButton?.addEventListener("click", async () => {
    try {
      copyButton.disabled = true;

      const currentPath = copyButton.dataset.path;
      const mdPath = `${currentPath}.md`;

      const res = await fetch(mdPath);
      const contentForClipboard = await res.text();

      await navigator.clipboard.writeText(contentForClipboard);
    } catch (error) {
      console.error(error);
      copyButttonClass = "error";
    } finally {
      copyButton.classList.add(copyButttonClass);
      copyButton.disabled = false;

      setTimeout(() => {
        copyButton.classList.remove(copyButttonClass);
      }, 3000);
    }
  });

  const dropdownToggle = document.querySelector(
    "#dropdown-toggle"
  ) as HTMLButtonElement;
  const dropdownMenu = document.querySelector("#dropdown-menu") as HTMLElement;

  dropdownToggle?.addEventListener("click", (e) => {
    e.stopPropagation();
    dropdownMenu.classList.toggle("show");
  });

  document.addEventListener("click", () => {
    dropdownMenu?.classList.remove("show");
  });

  dropdownMenu?.addEventListener("click", (e) => {
    e.stopPropagation();
  });
</script>